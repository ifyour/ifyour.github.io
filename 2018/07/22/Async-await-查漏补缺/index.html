<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#ffffff"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="apple-mobile-web-app-title" content="Ifyour's Blog"><meta name="msapplication-TileImage" content="/img/webAppIcon-256x256.png"><meta name="msapplication-TileColor" content="#000"><meta property="algolia:search" data-application-id="3XQ5CPDDMK" data-api-key="abe9e26eebcac723f34ade5cf6b97441" data-index-name="prod_blog"><title>Async/await 查漏补缺 · Ifyour's Blog</title><meta name="description" content="Async/await 查漏补缺 - Ifyour"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="manifest" href="/manifest.json"><link rel="icon" type="image/x-icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="apple-touch-icon" size="256x256" href="/img/webAppIcon-256x256.png"><link rel="apple-touch-icon" size="512x512" href="/img/webAppIcon-512x512.png"><link rel="apple-touch-startup-image" href="/img/apple-launch-750x1334.png"><link rel="preload" href="/css/apollo.css" as="style"><link rel="preload" href="/js/main.js" as="script"><link rel="search" type="application/opensearchdescription+xml" href="http://ifyour.github.io/atom.xml" title="Ifyour's Blog"></head><body><div class="search"><a href="javascript:;" target="_self" class="close"><svg id="icon-close" viewbox="0 0 16 16" width="24" height="24" fill="#A4A9AC"><path d="M8,15 C4.13400675,15 1,11.8659932 1,8 C1,4.13400675 4.13400675,1 8,1 C11.8659932,1 15,4.13400675 15,8 C15,11.8659932 11.8659932,15 8,15 Z M10.44352,10.7233105 L10.4528296,10.7326201 L10.7326201,10.4528296 C11.0310632,10.1543865 11.0314986,9.66985171 10.7335912,9.37194437 L9.36507937,8.0034325 L10.7360526,6.63245928 C11.0344957,6.33401613 11.0349311,5.84948135 10.7370237,5.55157401 L10.448426,5.26297627 C10.1505186,4.96506892 9.66598387,4.96550426 9.36754072,5.26394741 L8.00589385,6.62559428 L6.63738198,5.25708241 C6.33947464,4.95917507 5.85493986,4.95961041 5.55649671,5.25805356 L5.26737991,5.54717036 C4.96893676,5.84561351 4.96850142,6.33014829 5.26640876,6.62805563 L6.62561103,7.9872579 L5.25463781,9.35823112 C4.95619466,9.65667427 4.95575932,10.141209 5.25366666,10.4391164 L5.5422644,10.7277141 C5.84017175,11.0256215 6.32470652,11.0251861 6.62314967,10.726743 L7.99412289,9.35576976 L9.36263476,10.7242816 C9.66054211,11.022189 10.1450769,11.0217536 10.44352,10.7233105 Z"/></svg></a><div class="container"><input id="search-input" autocomplete="off" type="text" placeholder="Type to search" class="search-input"><div class="search-by">Search by<a href="https://www.algolia.com/" target="_blank"> algolia</a></div><div class="search-results"><div id="search-articles" class="search-item"></div></div></div><script id="search-tmp" type="text/html">{{if list.length}}
    <h3>ARTICLES</h3>
    <ul>
        {{each list item}}
        <li>
            <div class="search-item-title">
                <a href="{{item.permalink}}">{{@item.title}}</a>
            </div>
            <div class="search-item-summary" style="-webkit-box-orient: vertical;">
                {{@item.summary}}
            </div>
        </li>
        {{/each}}
    </ul>
{{else if list}}
    <h2>
        Oops! no result,
        Try it on <a target="_blank" style="color: #2c3e50; border-bottom: 2px solid #42b983; font-size: 19px;" href="https://www.google.com/search?q=site%3Aifyour.github.io+{{keywords}}">Google: {{keywords}}</a>~ 😱
    </h2>
{{/if}}</script></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/docs/" target="_self" class="nav-list-link">DOCS</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="javascript:;" target="_self" id="search" class="nav-list-link">SEARCH</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Async/await 查漏补缺</h1><div class="post-info">Jul 22, 2018</div><div class="sidebar-toc"><span>Catalog</span><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#async-函数"><span class="toc-text">async 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#async-作用"><span class="toc-text">async 作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#await-等待"><span class="toc-text">await 等待</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#async-await-链式处理"><span class="toc-text">async/await 链式处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#async-await-注意点"><span class="toc-text">async/await 注意点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#async-await-结合-try-catch-写法"><span class="toc-text">async/await 结合 try/catch 写法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考"><span class="toc-text">参考</span></a></li></ol></div><div class="post-content"><p>上周末我复习了 Promise 的用法，通过一些实例加深了 Promise 的理解。今天来看下异步编程的终极解决方案 async/await。JavaScript 中的异步操作从最初的 callback 演进到 Promise，再到 Generator，都是逐步的改进，而 async 函数的出现仿佛看到了异步方案的终点，用同步的方式写异步代码。</p>
<a id="more"></a>
<h3 id="async-函数"><a href="#async-函数" class="headerlink" title="async 函数"></a>async 函数</h3><p>简单解释：async 函数就是 Generator 函数的语法糖。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Generator 函数写法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> promise = <span class="function"><span class="keyword">function</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(val);</span><br><span class="line">      resolve(val);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> gen = <span class="function"><span class="keyword">function</span>*(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> p1 = <span class="keyword">yield</span> promise(<span class="string">'1'</span>);</span><br><span class="line">  <span class="keyword">let</span> p2 = <span class="keyword">yield</span> promise(<span class="string">'2'</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> genF = gen(); <span class="comment">// Iterator 对象</span></span><br><span class="line">genF.next(); <span class="comment">// =&gt; 1</span></span><br><span class="line">genF.next(); <span class="comment">// =&gt; 2</span></span><br></pre></td></tr></table></figure>
<p>更多 <code>yield</code> 表达式可以看这篇文章：<a href="https://juejin.im/post/5a6db41351882573351a8d72" target="_blank" rel="noopener">Generator 函数语法解析</a>。</p>
<p>使用 async 来改写上面的 <code>gen</code> 函数 👇：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> gen = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> p1 = <span class="keyword">await</span> promise(<span class="string">'1'</span>);</span><br><span class="line">  <span class="keyword">let</span> p2 = <span class="keyword">await</span> promise(<span class="string">'2'</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">gen();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出结果 👇：</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>async 函数是在 Generator 函数上进行的改进，语法上 Generator 函数的星号换成了 <code>async</code>，<code>yield</code> 换成了 <code>await</code>。</p>
<p>而 async 也与 Generator 函数 <strong>不同</strong>：</p>
<ul>
<li><code>async</code> 自带内置执行器，Generator 函数需要依靠执行器，并且 <code>async</code> 可以和普通函数一样，只需要一行</li>
<li>相对 Generator 函数，<code>async</code> 和 <code>await</code> 语义更清楚</li>
<li>适用性强，<code>yield</code> 后只能是 Thunk 函数和 Promise 对象，而 <code>await</code> 后可以是 Promise 对象和原始类型的值 (数值、字符串、布尔型等)</li>
</ul>
<h3 id="async-作用"><a href="#async-作用" class="headerlink" title="async 作用"></a>async 作用</h3><p>寄予 async 函数的期望是希望可以帮助我们解决异步操作问题，所以需要搞清楚 async 函数的返回值是什么。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">asyncAwait</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'async await'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> a = asyncAwait();</span><br><span class="line"><span class="built_in">console</span>.log(a);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出结果 👇：</span></span><br><span class="line"><span class="built_in">Promise</span> &#123;&lt;resolved&gt;: <span class="string">"async await"</span>&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出 async 函数返回的是一个 Promise 对象，如果函数中 return 一个直接量，async 函数会封装成 Promise 对象返回，而如果没有返回值时，async 函数会返回 <code>undefined</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 没有返回值时的输出结果 👇：</span></span><br><span class="line"><span class="built_in">Promise</span> &#123;&lt;resolved&gt;: <span class="literal">undefined</span>&#125;</span><br></pre></td></tr></table></figure>
<p>在没有结合 await 时，async 函数会立即执行，返回一个 Promise 对象。</p>
<h3 id="await-等待"><a href="#await-等待" class="headerlink" title="await 等待"></a>await 等待</h3><p>await 是个运算符，等待的结果是 Promise 对象或其它值，比如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'async'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">func2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(<span class="string">'await'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">asyncAwait</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> f1 = <span class="keyword">await</span> func1();</span><br><span class="line">  <span class="keyword">let</span> f2 = <span class="keyword">await</span> func2();</span><br><span class="line">  <span class="built_in">console</span>.log(f1, f2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">asyncAwait();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出结果 👇：</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">await</span></span><br></pre></td></tr></table></figure>
<p>await 表达式的运算取决于等待的结果，如果它等到的不是一个 Promise 对象，那运算结果就是它等到的东西, 而如果它等到的是一个 Promise 对象，它会阻塞后面的代码，等着 Promise 对象 resolve，然后得到 resolve 的值，作为表达式的运算结果。</p>
<div class="tip"><strong>async 函数调用</strong> 会封装在 Promise 中，这也是 await 需要在 async 函数中使用的原因。</div>

<h3 id="async-await-链式处理"><a href="#async-await-链式处理" class="headerlink" title="async/await 链式处理"></a>async/await 链式处理</h3><p>对于多个异步操作中，Promise 的 then 可以解决多层回调问题。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Promise 解决多层嵌套问题</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ajax</span>(<span class="params">t</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> resolve(t + <span class="number">200</span>), t);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">step1</span>(<span class="params">t</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`step1 in <span class="subst">$&#123;t&#125;</span>ms`</span>);</span><br><span class="line">  <span class="keyword">return</span> ajax(t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">step2</span>(<span class="params">t</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`step2 in <span class="subst">$&#123;t&#125;</span>ms`</span>);</span><br><span class="line">  <span class="keyword">return</span> ajax(t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">step3</span>(<span class="params">t</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`step3 in <span class="subst">$&#123;t&#125;</span>ms`</span>);</span><br><span class="line">  <span class="keyword">return</span> ajax(t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">submit</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.time(<span class="string">'submit'</span>);</span><br><span class="line">  step1(<span class="number">200</span>)</span><br><span class="line">    .then(<span class="function"><span class="params">time2</span> =&gt;</span> step2(time2))</span><br><span class="line">    .then(<span class="function"><span class="params">time3</span> =&gt;</span> step3(time3))</span><br><span class="line">    .then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`result is <span class="subst">$&#123;result&#125;</span>ms`</span>);</span><br><span class="line">      <span class="built_in">console</span>.timeEnd(<span class="string">'submit'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">submit();</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// async 函数实现，解决多层嵌套</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ajax</span>(<span class="params">t</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> resolve(t + <span class="number">200</span>), t);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">step1</span>(<span class="params">t</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`step1 in <span class="subst">$&#123;t&#125;</span>ms`</span>);</span><br><span class="line">  <span class="keyword">return</span> ajax(t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">step2</span>(<span class="params">t</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`step2 in <span class="subst">$&#123;t&#125;</span>ms`</span>);</span><br><span class="line">  <span class="keyword">return</span> ajax(t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">step3</span>(<span class="params">t</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`step3 in <span class="subst">$&#123;t&#125;</span>ms`</span>);</span><br><span class="line">  <span class="keyword">return</span> ajax(t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">submit</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.time(<span class="string">'submit'</span>);</span><br><span class="line">  <span class="keyword">const</span> t1 = <span class="number">200</span>;</span><br><span class="line">  <span class="keyword">const</span> t2 = <span class="keyword">await</span> step1(t1);</span><br><span class="line">  <span class="keyword">const</span> t3 = <span class="keyword">await</span> step2(t2);</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> step3(t3);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`result is <span class="subst">$&#123;result&#125;</span>`</span>);</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'submit'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">submit();</span><br></pre></td></tr></table></figure>
<p>输出结果 👇：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">step1 in 200ms</span><br><span class="line">step2 in 400ms</span><br><span class="line">step3 in 600ms</span><br><span class="line">result is 800</span><br><span class="line">submit: 1209.85107421875ms</span><br></pre></td></tr></table></figure>
<p>而如果需求变更，每一步的参数都是之前步骤的结果后，async 函数可以写成：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ajax</span>(<span class="params">t</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> resolve(t + <span class="number">200</span>), t);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">step1</span>(<span class="params">t1</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`step1 in <span class="subst">$&#123;t1&#125;</span>ms`</span>);</span><br><span class="line">  <span class="keyword">return</span> ajax(t1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">step2</span>(<span class="params">t1, t2</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`step2 in <span class="subst">$&#123;t1&#125;</span>ms,<span class="subst">$&#123;t2&#125;</span>ms`</span>);</span><br><span class="line">  <span class="keyword">return</span> ajax(t1 + t2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">step3</span>(<span class="params">t1, t2, t3</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`step3 in <span class="subst">$&#123;t1&#125;</span>ms,<span class="subst">$&#123;t2&#125;</span>ms,<span class="subst">$&#123;t3&#125;</span>ms`</span>);</span><br><span class="line">  <span class="keyword">return</span> ajax(t1 + t2 + t3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">submit</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.time(<span class="string">'submit'</span>);</span><br><span class="line">  <span class="keyword">const</span> t1 = <span class="number">200</span>;</span><br><span class="line">  <span class="keyword">const</span> t2 = <span class="keyword">await</span> step1(t1);</span><br><span class="line">  <span class="keyword">const</span> t3 = <span class="keyword">await</span> step2(t1, t2);</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> step3(t1, t2, t3);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`result is <span class="subst">$&#123;result&#125;</span>`</span>);</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">'submit'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">submit();</span><br></pre></td></tr></table></figure>
<p>输出结果 👇：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">step1 in 200ms</span><br><span class="line">step2 in 200ms,400ms</span><br><span class="line">step3 in 200ms,400ms,800ms</span><br><span class="line">result is 1600</span><br><span class="line">submit: 2210.47998046875ms</span><br></pre></td></tr></table></figure>
<h3 id="async-await-注意点"><a href="#async-await-注意点" class="headerlink" title="async/await 注意点"></a>async/await 注意点</h3><ol>
<li><code>async</code> 用来声明里面包裹的内容 <strong>能够以同步的方式执行</strong>，<code>await</code> 则是进行执行顺序控制，每次执行一个 <code>await</code>，阻塞代码执行等待 <code>await</code> 返回值，然后再执行之后的 <code>await</code></li>
<li><code>await</code> 只能用在 <code>async</code> 函数之中，用在普通函数中会报错</li>
<li><code>await</code> 命令后面的 Promise 对象，运行结果可能是 <code>rejected</code>，所以最好把 <code>await</code> 命令放在 <code>try...catch</code> 代码块中</li>
<li><code>await</code> 后面的表达式如果不是 Promise 实例，<code>await</code> 会阻塞后面的代码，然后执行 <code>async</code> 外面的同步代码，等同步代码执行完毕后回到 <code>async</code> 执行这个表达式作为 <code>await</code> 内容，详见这个 <a href="https://jsfiddle.net/zd4cbfrv/" target="_blank" rel="noopener">JSFiddle</a></li>
<li><code>await</code> 后面的表达式是一个 Promise 对象，<code>await</code> 也会暂停 <code>async</code> 后面的代码，先执行 <code>async</code> 外面的同步代码，等着 Promise 对象 <code>fulfilled</code>，然后把 <code>resolve</code> 的参数作为 await 表达式的运算结果，详见<a href="https://github.com/ifyour/learn-javascript/issues/15" target="_blank" rel="noopener">这道</a>面试题</li>
</ol>
<h4 id="async-await-结合-try-catch-写法"><a href="#async-await-结合-try-catch-写法" class="headerlink" title="async/await 结合 try/catch 写法"></a>async/await 结合 try/catch 写法</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">asyncAwait</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> promise();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 另一种写法</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">asyncAwait</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">await</span> promise().catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>Async/await 是 ES7 的重要特性之一，也是目前社区里公认的优秀异步解决方案，当你深入了解原理后会发现仿佛看到了异步回调隧道的尽头亮光。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="http://es6.ruanyifeng.com/#docs/generator" target="_blank" rel="noopener">Generator 函数的语法 @阮一峰《ECMAScript 6 入门》</a></li>
<li><a href="http://es6.ruanyifeng.com/#docs/async" target="_blank" rel="noopener">async 函数 @阮一峰《ECMAScript 6 入门》</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2018/09/11/webpack4-定制前端开发环境/" class="prev">PREV</a><a href="/2018/07/15/Promise-查漏补缺/" class="next">NEXT</a></div><div id="gc_container"></div><script src="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/gitment.browser.js"></script><script>(new Gitment({
    id: 'aid' + (new Date('Sun Jul 22 2018 14:44:15 GMT+0800')).getTime()/1000,
    title: 'Async/await 查漏补缺' + ' · 评论',
    link: decodeURI(location.protocol + '//' + location.hostname + location.pathname),
    repo: 'ifyour.github.io',
    owner: 'ifyour',
    oauth: {
        client_id: '576e98d38d4bd19f8a02',
        client_secret: 'ba3616bf2f20c5da947a1fd5c7ef0edff4ffab99',
    }
})).render('gc_container');</script><div class="copyright"><p>© 2015 - 2019 Made with <span>❤</span> by <a href="https://github.com/ifyour/ifyour.github.io">Ifyour</a></p><p>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div><script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.4.0/lib/darkmode-js.min.js"></script><script>new Darkmode({
    bottom: '1rem',
    right: '1rem',
    left: 'unset',
    time: '0.5s',
    mixColor: '#fff',
    backgroundColor: '#fff',
    buttonColorDark: '#100f2c',
    buttonColorLight: '#fff',
    saveInCookies: true,
    label: '🌓',
    autoMatchOsTheme: true
}).showWidget();
</script><script src="/js/algoliasearch.min.js"></script><script src="/js/template-web.min.js"></script><script src="/js/main.js"></script><script src="https://unpkg.com/medium-zoom@0/dist/medium-zoom.min.js"></script><script>mediumZoom('article img', {margin: 24});
(function(win, targetElem) {
    if (!targetElem) return;
    win.onscroll = (function() {
        if (isElementInViewport(targetElem)) {
            win.onscroll = null;
            return mediumZoom('.gitment-comment-main img', {margin: 24});
        }
        return arguments.callee;
    })();
    function isElementInViewport(el) {
        var rect = el.getBoundingClientRect();
        var winH = win.innerHeight || document.documentElement.clientHeight;
        return rect.top <= winH && rect.bottom >= winH;
    };
})(this, document.querySelector('#gc_container'));
</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-120929321-1",'auto');ga('send','pageview');</script></footer></div><script async>window.onload=function(){var a=document.createElement('script'),b=document.getElementsByTagName('script')[0];a.type='text/javascript',a.async=!0,a.src='/sw-register.js?v='+Date.now(),b.parentNode.insertBefore(a,b)};</script></body></html>