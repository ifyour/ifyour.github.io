---
title: å‰åç«¯é‰´æƒæ–¹å¼æ€»ç»“
comments: true
date: 2018-11-25 13:02:34
tags:
from:
---

ä»Šå¤©æ¥å­¦ä¹ ä¸‹å¸¸è§çš„é‰´æƒæ–¹å¼ï¼Œä»æœ€å¼€å§‹äº†è§£çš„æœ€ç®€å•çš„ Cookie éªŒè¯ï¼Œåˆ°åæ¥çš„ Session-cookieã€Token ç­‰ï¼Œæ•´ä½“æ¥è¯´ï¼Œå®‰å…¨æ€§è¶Šæ¥è¶Šé«˜ã€‚å½“ç„¶è¿˜æ˜¯å¯¹éƒ¨åˆ†æ–¹å¼äº†è§£ä¸æ˜¯å¾ˆæ·±ï¼Œè¿™é‡Œåšä¸ªç®€å•æ€»ç»“ï¼ŒæŸ¥æ¼è¡¥ç¼ºã€‚

<!-- more -->

ç›®å‰æˆ‘ä»¬å¸¸ç”¨çš„é‰´æƒæœ‰å››ç§ï¼š

1. HTTP Basic Authentication
2. Session-cookie
3. Token éªŒè¯
4. OAuth(å¼€æ”¾æˆæƒ)

### HTTP Basic Authentication

è¿™ç§æˆæƒæ–¹å¼æ˜¯æµè§ˆå™¨éµå®ˆ HTTP åè®®å®ç°çš„åŸºæœ¬æˆæƒæ–¹å¼ï¼ŒHTTP åè®®è¿›è¡Œé€šä¿¡çš„è¿‡ç¨‹ä¸­ï¼ŒHTTP åè®®å®šä¹‰äº†åŸºæœ¬è®¤è¯è®¤è¯å…è®¸ HTTP æœåŠ¡å™¨å¯¹å®¢æˆ·ç«¯è¿›è¡Œç”¨æˆ·èº«ä»½è¯çš„æ–¹æ³•ã€‚

#### è®¤è¯è¿‡ç¨‹

- 1ï¸âƒ£ å®¢æˆ·ç«¯å‘æœåŠ¡å™¨è¯·æ±‚æ•°æ®ï¼Œè¯·æ±‚çš„å†…å®¹å¯èƒ½æ˜¯ä¸€ä¸ªç½‘é¡µæˆ–è€…æ˜¯ä¸€ä¸ª ajax å¼‚æ­¥è¯·æ±‚ï¼Œæ­¤æ—¶ï¼Œå‡è®¾å®¢æˆ·ç«¯å°šæœªè¢«éªŒè¯ï¼Œåˆ™å®¢æˆ·ç«¯æä¾›å¦‚ä¸‹è¯·æ±‚è‡³æœåŠ¡å™¨ï¼š

```text
Get /index.html HTTP/1.0
Host:www.google.com
```

- 2ï¸âƒ£ æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€éªŒè¯è¯·æ±‚ä»£ç  401ï¼Œ(`WWW-Authenticate: Basic realm="google.com"` è¿™å¥è¯æ˜¯å…³é”®ï¼Œå¦‚æœæ²¡æœ‰å®¢æˆ·ç«¯ä¸ä¼šå¼¹å‡ºç”¨æˆ·åå’Œå¯†ç è¾“å…¥ç•Œé¢ï¼‰æœåŠ¡å™¨è¿”å›çš„æ•°æ®å¦‚ä¸‹ï¼š

```text
HTTP/1.0 401 Unauthorised
Server: SokEvo/1.0
WWW-Authenticate: Basic realm="google.com"
Content-Type: text/html
Content-Length: xxx
```

- 3ï¸âƒ£ å½“ç¬¦åˆ http1.0 æˆ– 1.1 è§„èŒƒçš„å®¢æˆ·ç«¯ï¼ˆå¦‚ IEï¼ŒFIREFOXï¼‰æ”¶åˆ° 401 è¿”å›å€¼æ—¶ï¼Œå°†è‡ªåŠ¨å¼¹å‡ºä¸€ä¸ªç™»å½•çª—å£ï¼Œè¦æ±‚ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ã€‚

- 4ï¸âƒ£ ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç åï¼Œå°†ç”¨æˆ·ååŠå¯†ç ä»¥ BASE64 åŠ å¯†æ–¹å¼åŠ å¯†ï¼Œå¹¶å°†å¯†æ–‡æ”¾å…¥å‰ä¸€æ¡è¯·æ±‚ä¿¡æ¯ä¸­ï¼Œåˆ™å®¢æˆ·ç«¯å‘é€çš„ç¬¬ä¸€æ¡è¯·æ±‚ä¿¡æ¯åˆ™å˜æˆå¦‚ä¸‹å†…å®¹ï¼š

```text
Get /index.html HTTP/1.0
Host:www.google.com
Authorization: Basic d2FuZzp3YW5n
```

<div class="tip">
`d2FuZzp3YW5n` è¡¨ç¤ºåŠ å¯†åçš„ç”¨æˆ·ååŠå¯†ç ï¼ˆç”¨æˆ·åï¼šå¯†ç  ç„¶åé€šè¿‡ base64 åŠ å¯†ï¼ŒåŠ å¯†è¿‡ç¨‹æ˜¯æµè§ˆå™¨é»˜è®¤çš„è¡Œä¸ºï¼Œä¸éœ€è¦æˆ‘ä»¬äººä¸ºåŠ å¯†ï¼Œæˆ‘ä»¬åªéœ€è¦è¾“å…¥ç”¨æˆ·åå¯†ç å³å¯ï¼‰
</div>

- 5ï¸âƒ£ æœåŠ¡å™¨æ”¶åˆ°ä¸Šè¿°è¯·æ±‚ä¿¡æ¯åï¼Œå°† Authorization å­—æ®µåçš„ç”¨æˆ·ä¿¡æ¯å–å‡ºã€è§£å¯†ï¼Œå°†è§£å¯†åçš„ç”¨æˆ·ååŠå¯†ç ä¸ç”¨æˆ·æ•°æ®åº“è¿›è¡Œæ¯”è¾ƒéªŒè¯ï¼Œå¦‚ç”¨æˆ·ååŠå¯†ç æ­£ç¡®ï¼ŒæœåŠ¡å™¨åˆ™æ ¹æ®è¯·æ±‚ï¼Œå°†æ‰€è¯·æ±‚èµ„æºå‘é€ç»™å®¢æˆ·ç«¯ã€‚

å®¢æˆ·ç«¯æœªæœªè®¤è¯çš„æ—¶å€™ï¼Œä¼šå¼¹å‡ºç”¨æˆ·åå¯†ç è¾“å…¥æ¡†ï¼Œè¿™ä¸ªæ—¶å€™è¯·æ±‚æ—¶å±äº pending çŠ¶æ€ï¼Œè¿™ä¸ªæ—¶å€™å…¶å®æœåŠ¡å½“ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå¯†ç çš„æ—¶å€™å®¢æˆ·ç«¯ä¼šå†æ¬¡å‘é€å¸¦ Authentication å¤´çš„è¯·æ±‚ã€‚

è¯·æ±‚è®¤è¯ ğŸ‘‡
![image](https://user-images.githubusercontent.com/15377484/48976178-136a0300-f0bd-11e8-9fd6-b2e67d22bbc6.png)

è®¤è¯æˆåŠŸ ğŸ‘‡
![image](https://user-images.githubusercontent.com/15377484/48976167-d1d95800-f0bc-11e8-80fa-35c636dbc103.png)

#### å®Œæ•´ä»£ç 

**Server.js**

```js
let express = require('express');
let app = express();

app.use(express.static(__dirname + '/public'));
app.get('/Authentication_base', function(req, res) {
  console.log('req.headers.authorization:', req.headers);
  if (!req.headers.authorization) {
    res.set({
      'WWW-Authenticate': 'Basic realm="wang"'
    });
    res.status(401).end();
  } else {
    let base64 = req.headers.authorization.split(' ')[1];
    let userPass = new Buffer(base64, 'base64').toString().split(':');
    let user = userPass[0];
    let pass = userPass[1];
    if (user === 'wang' && pass === 'wang') {
      res.end('OK');
    } else {
      res.status(401).end();
    }
  }
});

app.listen(9090);
```

**index.html**

```html
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>HTTP Basic Authentication</title>
  </head>
  <body>
    <div></div>
    <script src="js/jquery-3.2.1.js"></script>
    <script>
      $(function() {
        send('./Authentication_base');
      });
      var send = function(url) {
        $.ajax({
          url: url,
          method: 'GET'
        });
      };
    </script>
  </body>
</html>
```

å½“ç„¶æœ‰ç™»é™†å°±æœ‰æ³¨é”€ï¼Œæˆ‘ä»¬ä¼šå‘ç°å½“æˆ‘ä»¬è®¤è¯æˆåŠŸåæ¯æ¬¡è¯·æ±‚è¯·æ±‚å¤´éƒ½ä¼šå¸¦ä¸Š Authentication åŠé‡Œé¢çš„å†…å®¹ï¼Œé‚£ä¹ˆå¦‚ä½•åšåˆ°è®©è¿™æ¬¡ç™»é™†å¤±æ•ˆçš„ï¼Ÿ

ç½‘ä¸ŠæŸ¥äº†åŠå¤©ï¼Œç›®å‰æœ€æœ‰æ•ˆçš„æ–¹å¼å°±æ˜¯åœ¨æ³¨é”€æ“ä½œçš„æ—¶å€™ï¼Œä¸“é—¨åœ¨æœåŠ¡å™¨è®¾ç½®ä¸€ä¸ªä¸“é—¨çš„æ³¨é”€è´¦å·ï¼Œå½“æ¥æ”¶åˆ°çš„ Authentication ä¿¡æ¯ä¸ºæ³¨é”€ç”¨æˆ·åå¯†ç çš„æ—¶å€™çº å°±å¸¦ä¾¿æ³¨é”€æˆåŠŸäº†ï¼Œè€Œå®¢æˆ·ç«¯åœ¨æ³¨é”€æ“ä½œçš„æ—¶å€™ï¼Œæ‰‹åŠ¨çš„çš„å»ä¿®æ”¹è¯·æ±‚å¤´é‡çš„ Authenticationï¼Œå°†ä»–è®¾ç½®æœªæœåŠ¡å™¨é»˜è®¤çš„æ³¨é”€è´¦å·å’Œå¯†ç ã€‚

é€šè¿‡ä¸Šé¢çš„ç®€å•è®²è§£ å…¶å®æˆ‘ä»¬å·²ç»å¯ä»¥è¿”ç°è¿™ç§éªŒè¯æ–¹å¼çš„ç¼ºé™·åŠ å¯†æ–¹å¼ç®€å•ï¼Œä»…ä»…æ˜¯ base64 åŠ å¯†ï¼Œè¿™ç§åŠ å¯†æ–¹å¼æ˜¯å¯é€†çš„ã€‚åŒæ—¶åœ¨æ¯ä¸ªè¯·æ±‚çš„å¤´ä¸Šéƒ½ä¼šé™„å¸¦ä¸Šç”¨æˆ·åå’Œå¯†ç ä¿¡æ¯ï¼Œè¿™æ ·åœ¨å¤–ç½‘æ˜¯å¾ˆå®¹æ˜“è¢«å—…æ¢å™¨æ¢æµ‹åˆ°çš„ã€‚

æ­£å¼å› ä¸ºè¿™æ ·ï¼Œè¿™ç§åŠ å¯†æ–¹å¼ä¸€èˆ¬å¤šè¢«ç”¨åœ¨å†…éƒ¨å®‰å…¨æ€§è¦æ±‚ä¸é«˜çš„çš„ç³»ç»Ÿä¸Šï¼Œåªæ˜¯ç›¸å¯¹çš„å¤šï¼Œæ€»çš„æ¥è¯´ç°åœ¨ä½¿ç”¨è¿™ç§é‰´æƒæ¯”è¾ƒå°‘äº†ã€‚å¦‚æœé¡¹ç›®éœ€è¦éƒ¨ç½²åœ¨å…¬ç½‘ä¸Šï¼Œè¿™ç§æ–¹å¼ä¸æ¨èï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥å’Œ SSL æ¥åŠ å¯†ä¼ è¾“ï¼Œè¿™æ ·ä¼šå¥½ä¸€ç‚¹ï¼Œè¿™ä¸ªå¦‚æœæˆ‘åé¢æœ‰æ—¶é—´æ¥ç ”ç©¶ä¸€ä¸‹ã€‚

### Session-cookie

ç¬¬äºŒç§è¿™ä¸ªæ–¹å¼æ˜¯åˆ©ç”¨æœåŠ¡å™¨ç«¯çš„ sessionï¼ˆä¼šè¯ï¼‰å’Œæµè§ˆå™¨ç«¯çš„ cookie æ¥å®ç°å‰åç«¯çš„è®¤è¯ï¼Œç”±äº http è¯·æ±‚æ—¶æ˜¯æ— çŠ¶æ€çš„ï¼ŒæœåŠ¡å™¨æ­£å¸¸æƒ…å†µä¸‹æ˜¯ä¸çŸ¥é“å½“å‰è¯·æ±‚ä¹‹å‰æœ‰æ²¡æœ‰æ¥è¿‡ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¦‚æœè¦è®°å½•çŠ¶æ€ï¼Œå°±éœ€è¦åœ¨æœåŠ¡å™¨ç«¯åˆ›å»ºä¸€ä¸ªä¼šè¯ (seesion), å°†åŒä¸€ä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚éƒ½ç»´æŠ¤åœ¨å„è‡ªå¾—ä¼šä¼šè¯ä¸­ï¼Œæ¯å½“è¯·æ±‚åˆ°è¾¾æœåŠ¡å™¨ç«¯çš„æ—¶å€™ï¼Œå…ˆå»æŸ¥ä¸€ä¸‹è¯¥å®¢æˆ·ç«¯æœ‰æ²¡æœ‰åœ¨æœåŠ¡å™¨ç«¯åˆ›å»º seesionï¼Œå¦‚æœæœ‰åˆ™å·²ç»è®¤è¯æˆåŠŸäº†ï¼Œå¦åˆ™å°±æ²¡æœ‰è®¤è¯ã€‚

#### è®¤è¯è¿‡ç¨‹

1. æœåŠ¡å™¨åœ¨æ¥å—å®¢æˆ·ç«¯é¦–æ¬¡è®¿é—®æ—¶åœ¨æœåŠ¡å™¨ç«¯åˆ›å»º seesionï¼Œç„¶åä¿å­˜ seesionï¼ˆæˆ‘ä»¬å¯ä»¥å°† seesion ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œä¹Ÿå¯ä»¥ä¿å­˜åœ¨ redis ä¸­ï¼Œæ¨èä½¿ç”¨åè€…ï¼‰ï¼Œç„¶åç»™è¿™ä¸ª session ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†å­—ç¬¦ä¸², ç„¶ååœ¨å“åº”å¤´ä¸­ç§ä¸‹è¿™ä¸ªå”¯ä¸€æ ‡è¯†å­—ç¬¦ä¸²ã€‚
2. ç­¾åã€‚è¿™ä¸€æ­¥åªæ˜¯å¯¹ sid è¿›è¡ŒåŠ å¯†å¤„ç†ï¼ŒæœåŠ¡ç«¯ä¼šæ ¹æ®è¿™ä¸ª secret å¯†é’¥è¿›è¡Œè§£å¯†ã€‚ï¼ˆéå¿…éœ€æ­¥éª¤ï¼‰
3. æµè§ˆå™¨ä¸­æ”¶åˆ°è¯·æ±‚å“åº”çš„æ—¶å€™ä¼šè§£æå“åº”å¤´ï¼Œç„¶åå°† sid ä¿å­˜åœ¨æœ¬åœ° cookie ä¸­ï¼Œæµè§ˆå™¨åœ¨ä¸‹æ¬¡ http è¯·æ±‚çš„è¯·æ±‚å¤´ä¸­ä¼šå¸¦ä¸Šè¯¥åŸŸåä¸‹çš„ cookie ä¿¡æ¯ã€‚
4. æœåŠ¡å™¨åœ¨æ¥å—å®¢æˆ·ç«¯è¯·æ±‚æ—¶ä¼šå»è§£æè¯·æ±‚å¤´ cookie ä¸­çš„ sidï¼Œç„¶åæ ¹æ®è¿™ä¸ª sid å»æ‰¾æœåŠ¡å™¨ç«¯ä¿å­˜çš„è¯¥å®¢æˆ·ç«¯çš„ sessionï¼Œç„¶ååˆ¤æ–­è¯¥è¯·æ±‚æ˜¯å¦åˆæ³•ã€‚

![](https://user-images.githubusercontent.com/15377484/38019076-382f84f8-32a9-11e8-9c5d-ef47b58185ad.png)

#### å®Œæ•´ä»£ç 

**server.js**

```js
var express = require('express');
var RedisStore = require('connect-redis')(express.session);
var app = express();
var secret = 'ifyour';
// è®¾ç½® Cookie
app.use(express.cookieParser(secret));

// è®¾ç½® Session
app.use(
  express.session({
    store: new RedisStore({
      host: '127.0.0.1',
      port: 6379,
      db: 'session_db'
    }),
    secret: secret
  })
);

app.get('/', function(req, res) {
  var session = req.session;
  session.time = session.time || 0;
  var n = session.time++;
  res.send('hello, session id:' + session.id + 'count:' + n);
});

app.listen(9080);
```

### Token éªŒè¯

#### è®¤è¯è¿‡ç¨‹

1. å®¢æˆ·ç«¯ä½¿ç”¨ç”¨æˆ·åè·Ÿå¯†ç è¯·æ±‚ç™»å½•
2. æœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚ï¼Œå»éªŒè¯ç”¨æˆ·åä¸å¯†ç 
3. éªŒè¯æˆåŠŸåï¼ŒæœåŠ¡ç«¯ä¼šç­¾å‘ä¸€ä¸ª Tokenï¼Œå†æŠŠè¿™ä¸ª Token å‘é€ç»™å®¢æˆ·ç«¯
4. å®¢æˆ·ç«¯æ”¶åˆ° Token ä»¥åå¯ä»¥æŠŠå®ƒå­˜å‚¨èµ·æ¥ï¼Œæ¯”å¦‚æ”¾åœ¨ Cookie é‡Œæˆ–è€… LocalStorage é‡Œ
5. å®¢æˆ·ç«¯æ¯æ¬¡å‘æœåŠ¡ç«¯è¯·æ±‚èµ„æºçš„æ—¶å€™éœ€è¦å¸¦ç€æœåŠ¡ç«¯ç­¾å‘çš„ Token
6. æœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚ï¼Œç„¶åå»éªŒè¯å®¢æˆ·ç«¯è¯·æ±‚é‡Œé¢å¸¦ç€çš„ Tokenï¼Œå¦‚æœéªŒè¯æˆåŠŸï¼Œå°±å‘å®¢æˆ·ç«¯è¿”å›è¯·æ±‚çš„æ•°æ®

æ€»çš„æ¥è¯´å°±æ˜¯å®¢æˆ·ç«¯åœ¨é¦–æ¬¡ç™»é™†ä»¥åï¼ŒæœåŠ¡ç«¯å†æ¬¡æ¥æ”¶ http è¯·æ±‚çš„æ—¶å€™ï¼Œå°±åªè®¤ token äº†ï¼Œè¯·æ±‚åªè¦æ¯æ¬¡æŠŠ token å¸¦ä¸Šå°±è¡Œäº†ï¼ŒæœåŠ¡å™¨ç«¯ä¼šæ‹¦æˆªæ‰€æœ‰çš„è¯·æ±‚ï¼Œç„¶åæ ¡éªŒ token çš„åˆæ³•æ€§ï¼Œåˆæ³•å°±æ”¾è¡Œï¼Œä¸åˆæ³•å°±è¿”å› 401ï¼ˆé‰´æƒå¤±è´¥ï¼‰ã€‚

ä¹çš„ä¸€çœ‹å¥½åƒå’Œå‰é¢çš„ seesion-cookie æœ‰ç‚¹åƒï¼Œseesion-cookie æ˜¯é€šè¿‡ seesionid æ¥ä½œä¸ºæµè§ˆå™¨å’ŒæœåŠ¡ç«¯çš„é“¾æ¥æ¡¥æ¢ï¼Œè€Œ token éªŒè¯æ–¹å¼è²Œä¼¼æ˜¯ token æ¥èµ·åˆ° seesionid çš„è§’è‰²ã€‚å…¶å®è¿™ä¸¤è€…å·®åˆ«æ˜¯å¾ˆå¤§çš„ã€‚

#### ä¸ seesion-cookie çš„åŒºåˆ«

1. sessionid æ˜¯ä¸€ä¸ªå”¯ä¸€æ ‡è¯†çš„å­—ç¬¦ä¸²ï¼ŒæœåŠ¡ç«¯æ˜¯æ ¹æ®è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œæ¥æŸ¥è¯¢åœ¨æœåŠ¡å™¨ç«¯ä¿æŒçš„ seesionï¼Œè¿™é‡Œé¢æ‰ä¿å­˜ç€ç”¨æˆ·çš„ç™»é™†çŠ¶æ€ã€‚ä½†æ˜¯ token æœ¬èº«å°±æ˜¯ä¸€ç§ç™»é™†æˆåŠŸå‡­è¯ï¼Œä»–æ˜¯åœ¨ç™»é™†æˆåŠŸåæ ¹æ®æŸç§è§„åˆ™ç”Ÿæˆçš„ä¸€ç§ä¿¡æ¯å‡­è¯ï¼Œä»–é‡Œé¢æœ¬èº«å°±ä¿å­˜ç€ç”¨æˆ·çš„ç™»é™†çŠ¶æ€ã€‚æœåŠ¡å™¨ç«¯åªéœ€è¦æ ¹æ®å®šä¹‰çš„è§„åˆ™æ ¡éªŒè¿™ä¸ª token æ˜¯å¦åˆæ³•å°±è¡Œã€‚
2. session-cookie æ˜¯éœ€è¦ cookie é…åˆçš„ï¼Œå±…ç„¶è¦ cookieï¼Œé‚£ä¹ˆåœ¨ http ä»£ç†å®¢æˆ·ç«¯çš„é€‰æ‹©ä¸Šå°±æ˜¯åªæœ‰æµè§ˆå™¨äº†ï¼Œå› ä¸ºåªæœ‰æµè§ˆå™¨æ‰ä¼šå»è§£æè¯·æ±‚å“åº”å¤´é‡Œé¢çš„ cookie, ç„¶åæ¯æ¬¡è¯·æ±‚å†é»˜è®¤å¸¦ä¸Šè¯¥åŸŸåä¸‹çš„ cookieã€‚ä½†æ˜¯æˆ‘ä»¬çŸ¥é“ http ä»£ç†å®¢æˆ·ç«¯ä¸åªæœ‰æµè§ˆå™¨ï¼Œè¿˜æœ‰åŸç”Ÿ APP ç­‰ç­‰ï¼Œè¿™ä¸ªæ—¶å€™ cookie æ˜¯ä¸èµ·ä½œç”¨çš„ï¼Œæˆ–è€…æµè§ˆå™¨ç«¯æ˜¯å¯ä»¥ç¦æ­¢ cookie çš„ (è™½ç„¶å¯ä»¥ï¼Œä½†æ˜¯è¿™åŸºæœ¬ä¸Šæ˜¯å±äºåƒé¥±æ²¡äº‹å¹²çš„äººå¹²çš„äº‹)ï¼Œä½†æ˜¯ token å°±ä¸ä¸€æ ·ï¼Œä»–æ˜¯ç™»é™†è¯·æ±‚åœ¨ç™»é™†æˆåŠŸåå†è¯·æ±‚å“åº”ä½“ä¸­è¿”å›çš„ä¿¡æ¯ï¼Œå®¢æˆ·ç«¯åœ¨æ”¶åˆ°å“åº”çš„æ—¶å€™ï¼Œå¯ä»¥æŠŠä»–å­˜åœ¨æœ¬åœ°çš„ cookieã€storageï¼Œæˆ–è€…å†…å­˜ä¸­ï¼Œç„¶åå†ä¸‹ä¸€æ¬¡è¯·æ±‚çš„è¯·æ±‚å¤´é‡å¸¦ä¸Šè¿™ä¸ª token å°±è¡Œäº†ã€‚ç®€å•ç‚¹æ¥è¯´ cookie-session æœºåˆ¶ä»–é™åˆ¶äº†å®¢æˆ·ç«¯çš„ç±»å‹ï¼Œè€Œ token éªŒè¯æœºåˆ¶ä¸°å¯Œäº†å®¢æˆ·ç«¯ç±»å‹ã€‚
3. æ—¶æ•ˆæ€§ã€‚session-cookie çš„ sessionid æ˜¯åœ¨ç™»é™†æ—¶ç”Ÿæˆçš„ï¼Œè€Œä¸”åœ¨ç™»å‡ºæ—¶ä¸€ç›´ä¸å˜ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šå®‰å…¨æ€§å°±ä¼šé™ä½ï¼Œè€Œ token æ˜¯å¯ä»¥åœ¨ä¸€æ®µæ—¶é—´å†…åŠ¨æ€æ”¹å˜çš„ã€‚
4. å¯æ‰©å±•æ€§ã€‚token éªŒè¯æœ¬èº«æ˜¯æ¯”è¾ƒçµæ´»çš„ï¼Œä¸€æ˜¯ token çš„è§£å†³æ–¹æ¡ˆæœ‰è®¸å¤šï¼Œå¸¸ç”¨çš„æ˜¯ JWTï¼ŒäºŒæ¥æˆ‘ä»¬å¯ä»¥åŸºäº token éªŒè¯æœºåˆ¶ï¼Œä¸“é—¨åšä¸€ä¸ªé‰´æƒæœåŠ¡ï¼Œç”¨å®ƒå‘å¤šä¸ªæœåŠ¡çš„è¯·æ±‚è¿›è¡Œç»Ÿä¸€é‰´æƒã€‚

ä¸‹é¢å°±æ‹¿æœ€å¸¸ç”¨çš„ JWTï¼ˆJSON WEB TOKENï¼‰æ¥è¯´ï¼š

JWT æ˜¯ Auth0 æå‡ºçš„é€šè¿‡å¯¹ JSON è¿›è¡ŒåŠ å¯†ç­¾åæ¥å®ç°æˆæƒéªŒè¯çš„æ–¹æ¡ˆï¼Œå°±æ˜¯ç™»é™†æˆåŠŸåå°†ç›¸å…³ä¿¡æ¯ç»„æˆ json å¯¹è±¡ï¼Œç„¶åå¯¹è¿™ä¸ªå¯¹è±¡è¿›è¡ŒæŸä¸­æ–¹å¼çš„åŠ å¯†ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯åœ¨ä¸‹æ¬¡è¯·æ±‚æ—¶å¸¦ä¸Šè¿™ä¸ª tokenï¼ŒæœåŠ¡ç«¯å†æ”¶åˆ°è¯·æ±‚æ—¶æ ¡éªŒ token åˆæ³•æ€§ï¼Œå…¶å®ä¹Ÿå°±æ˜¯åœ¨æ ¡éªŒè¯·æ±‚çš„åˆæ³•æ€§ã€‚JWT å¯¹è±¡é€šå¸¸ç”±ä¸‰éƒ¨åˆ†æ„æˆï¼š

1ï¸âƒ£ Headersï¼š åŒ…æ‹¬ç±»åˆ«ï¼ˆtypï¼‰ã€åŠ å¯†ç®—æ³•ï¼ˆalgï¼‰

```json
{
  "alg": "HS256",
  "typ": "JWT"
}
```

2ï¸âƒ£ Claimsï¼šåŒ…æ‹¬éœ€è¦ä¼ é€’çš„ç”¨æˆ·ä¿¡æ¯

```json
{
  "sub": "1234567890",
  "name": "John Doe",
  "admin": true
}
```

3ï¸âƒ£ Signatureï¼šæ ¹æ® alg ç®—æ³•ä¸ç§æœ‰ç§˜é’¥è¿›è¡ŒåŠ å¯†å¾—åˆ°çš„ç­¾åå­—ä¸²ï¼Œè¿™ä¸€æ®µæ˜¯æœ€é‡è¦çš„æ•æ„Ÿä¿¡æ¯ï¼Œåªèƒ½åœ¨æœåŠ¡ç«¯è§£å¯†

```text
HMACSHA256(
  base64UrlEncode(Headers) + '.' + base64UrlEncode(Claims),
  SECREATE_KEY
);
```

ç¼–ç ä¹‹åçš„ JWT çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ä¸€ä¸²å­—ç¬¦ï¼š

```text
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ
```

#### å®Œæ•´ä»£ç 

**auth.js**

```js
let jwt = require('jwt-simple');
let secret = 'wangyy';
let time = 10;
module.exports = {
  /* æ£€éªŒ token åˆæ³•æ€§ */
  validate: function(req, res, next) {
    let token = req.body.token || req.headers['xssToken'];
    if (token) {
      let decodeToken = null;
      try {
        // é˜²æ­¢å‡å†’ token è§£ææŠ¥é”™
        decodeToken = jwt.decode(token, secret, 'HS256');
      } catch (err) {
        res.status(401).send('éæ³•è®¿é—®');
        return;
      }
      let exp = decodeToken.exp;
      if (!exp) {
        res.status(401).send('éæ³•è®¿é—®');
      }
      let now = new Date().getTime();
      if (exp > now + time * 60 * 1000) {
        res.send({ code: '002', errorMsg: 'æˆæƒè¶…æ—¶' });
      }
      next();
    } else {
      res.status(401).send('éæ³•è®¿é—®');
    }
  },
  /* ç”Ÿæˆ token*/
  makeToken() {
    let Token = null;
    let payload = {
      time: new Date().getTime(),
      exp: this.makeExp(time)
    };
    Token = jwt.encode(payload, secret, HS256);
    return Token;
  },
  /* ç”Ÿæˆ token è¿‡æœŸæ—¶é—´ */
  makeExp: function(time) {
    let stam = time601000;
  }
};
```

**Server.js**

```js
let express = require('express');
let app = express();
let bodyParser = require('body-parser');
let auth = require('./lib/auth.js');
let chalk = require('chalk');

app.use(bodyParser.json());
app.post('/login', function(req, res, next) {
  let Token = auth.makeToken();
  res.json({ result: 'success', token: Token }, 200);
});
app.use('*', [auth.validate], function(req, res, next) {
  res.send('success');
});

app.listen('9999');
```

### OAuth(å¼€æ”¾æˆæƒ)

OAuthï¼ˆå¼€æ”¾æˆæƒï¼‰æ˜¯ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼Œå…è®¸ç”¨æˆ·æˆæƒç¬¬ä¸‰æ–¹ç½‘ç«™è®¿é—®ä»–ä»¬å­˜å‚¨åœ¨å¦å¤–çš„æœåŠ¡æä¾›è€…ä¸Šçš„ä¿¡æ¯ï¼Œè€Œä¸éœ€è¦å°†ç”¨æˆ·åå’Œå¯†ç æä¾›ç»™ç¬¬ä¸‰æ–¹ç½‘ç«™æˆ–åˆ†äº«ä»–ä»¬æ•°æ®çš„æ‰€æœ‰å†…å®¹ï¼Œä¸ºäº†ä¿æŠ¤ç”¨æˆ·æ•°æ®çš„å®‰å…¨å’Œéšç§ï¼Œç¬¬ä¸‰æ–¹ç½‘ç«™è®¿é—®ç”¨æˆ·æ•°æ®å‰éƒ½éœ€è¦æ˜¾å¼çš„å‘ç”¨æˆ·å¾æ±‚æˆæƒã€‚æˆ‘ä»¬å¸¸è§çš„æä¾› OAuth è®¤è¯æœåŠ¡çš„å‚å•†æœ‰æ”¯ä»˜å®ã€QQã€å¾®ä¿¡ã€‚

OAuth åè®®åˆæœ‰ 1.0 å’Œ 2.0 ä¸¤ä¸ªç‰ˆæœ¬ã€‚ç›¸æ¯”è¾ƒ 1.0 ç‰ˆï¼Œ2.0 ç‰ˆæ•´ä¸ªæˆæƒéªŒè¯æµç¨‹æ›´ç®€å•æ›´å®‰å…¨ï¼Œä¹Ÿæ˜¯ç›®å‰æœ€ä¸»è¦çš„ç”¨æˆ·èº«ä»½éªŒè¯å’Œæˆæƒæ–¹å¼ã€‚

#### è®¤è¯è¿‡ç¨‹

ä¸‹é¢æ˜¯ä¸€å¼  Auth2.0 çš„æµç¨‹å›¾ï¼š

![image](https://user-images.githubusercontent.com/15377484/48976006-b7ea4600-f0b9-11e8-8f94-1102761320b0.png)

ä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒAuth2.0 æµç¨‹åˆ†ä¸ºå…­æ­¥ï¼š

1ï¸âƒ£ å‘ç”¨æˆ·è¯·æ±‚æˆæƒï¼Œç°åœ¨å¾ˆå¤šçš„ç½‘ç«™åœ¨ç™»é™†çš„æ—¶å€™éƒ½æœ‰ç¬¬ä¸‰æ–¹ç™»é™†çš„å…¥å£ï¼Œå½“æˆ‘ä»¬ç‚¹å‡»ç­‰ç¬¬ä¸‰æ–¹å…¥å£æ—¶ï¼Œç¬¬ä¸‰æ–¹æˆæƒæœåŠ¡ä¼šå¼•å¯¼æˆ‘ä»¬è¿›å…¥ç¬¬ä¸‰æ–¹ç™»é™†æˆæƒé¡µé¢ã€‚

![image](https://user-images.githubusercontent.com/15377484/48976180-35638580-f0bd-11e8-9c0a-c6aee6bf7da5.png)

é€šè¿‡ç¬¬ä¸‰æ–¹è¯·æ±‚æˆæƒé¡µé¢çš„æµè§ˆå™¨åœ°å€æ åœ°å€å¯ä»¥çœ‹å‡ºï¼š

```text
https://graph.qq.com/oauth2.0/show?which=Login&display=pc&response_type=code&client_id=100270989&redirect_uri=https%3A%2F%2Fpassport.csdn.net%2Faccount%2Flogin%3Foauth_provider%3DQQProvider&state=test
```

è¿™é‡Œçš„åœ°å€é‡Œé¢çš„ `%` æ˜¯æµè§ˆå™¨å¼ºåˆ¶ç¼–ç åçš„æ˜¾ç¤ºæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `decodeURIComponent` è¿›è¡Œè§£ç ï¼Œè§£ç åæ˜¯è¿™æ ·ï¼š

```text
https://graph.qq.com/oauth2.0/show?which=Login&display=pc&response_type=code&client_id=100270989&redirect_uri=https://passport.csdn.net/account/login?oauth_provider=QQProvider&state=test
```

è¿™ä¸ª url åœ°å€æˆ‘ä»¬å¯ä»¥çœ‹è§ Auth2.0 å¸¸è§çš„å‡ ä¸ªå‚æ•°ï¼š

```text
response_type:  è¿”å›ç±»å‹
client_id:      ç¬¬ä¸‰æ–¹åº”ç”¨ id, ç”±æˆæƒæœåŠ¡å™¨ï¼ˆqqï¼‰åœ¨ç¬¬ä¸‰æ–¹åº”ç”¨æäº¤æ—¶é¢å‘ç»™ç¬¬ä¸‰æ–¹åº”ç”¨ã€‚
redirect_uri:   ç™»é™†æˆåŠŸé‡å®šå‘é¡µé¢
oauth_provider: ç¬¬ä¸‰æ–¹æˆæƒæä¾›æ–¹
state:          ç”±ç¬¬ä¸‰æ–¹åº”ç”¨ç»™å‡ºçš„éšæœºç 
```

2ï¸âƒ£ è¿”å›ç”¨æˆ·å‡­è¯ï¼ˆcodeï¼‰ï¼Œå¹¶è¿”å›ä¸€ä¸ªå‡­è¯ï¼ˆcodeï¼‰ï¼Œå½“ç”¨æˆ·ç‚¹å‡»æˆæƒå¹¶ç™»é™†åï¼ŒæˆæƒæœåŠ¡å™¨å°†ç”Ÿæˆä¸€ä¸ªç”¨æˆ·å‡­è¯ï¼ˆcodeï¼‰ã€‚è¿™ä¸ªç”¨æˆ·å‡­è¯ä¼šé™„åŠ åœ¨é‡å®šå‘çš„åœ°å€ `redirect_uri` çš„åé¢

```text
https://passport.csdn.net/account/login?code=9e3efa6cea739f9aaab2&state=XXX
```

3ï¸âƒ£ è¯·æ±‚æˆæƒæœåŠ¡å™¨æˆæƒ

ç»è¿‡ç¬¬äºŒéƒ¨è·å– code ååé¢çš„å·¥ä½œå°±å¯ä»¥äº¤ç»™åå°å»å¤„ç†çš„ï¼Œå’Œç”¨æˆ·çš„äº¤äº’å°±ç»“æŸäº†ã€‚æ¥ä¸‹æ¥æˆ‘çš„éœ€è¦è·å–å‡­è¯ï¼ˆAccess Tokenï¼‰ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ä»–æ¥å‘æˆæƒæœåŠ¡å™¨è·å–ç”¨æˆ·ä¿¡æ¯ç­‰èµ„æºã€‚ ç¬¬ä¸‰æ–¹åº”ç”¨åå°é€šè¿‡ç¬¬äºŒæ­¥çš„å‡­è¯ï¼ˆcodeï¼‰å‘æˆæƒæœåŠ¡å™¨è¯·æ±‚å‡­è¯ï¼ˆAccess Tokenï¼‰ï¼Œè¿™æ—¶å€™éœ€è¦ä»¥ä¸‹å‡ ä¸ªä¿¡æ¯ï¼š

- `client_id`: æ ‡è¯†ç¬¬ä¸‰æ–¹åº”ç”¨çš„ idï¼Œç”±æˆæƒæœåŠ¡å™¨åœ¨ç¬¬ä¸‰æ–¹åº”ç”¨æäº¤æ—¶é¢å‘ç»™ç¬¬ä¸‰æ–¹åº”ç”¨
- `client_secret`: ç¬¬ä¸‰æ–¹åº”ç”¨å’ŒæˆæƒæœåŠ¡å™¨ä¹‹é—´çš„å®‰å…¨å‡­è¯ï¼Œç”±æˆæƒæœåŠ¡å™¨åœ¨ç¬¬ä¸‰æ–¹åº”ç”¨æäº¤æ—¶é¢å‘ç»™ç¬¬ä¸‰æ–¹åº”ç”¨
- `code`: ç¬¬ä¸€æ­¥ä¸­è¿”å›çš„ç”¨æˆ·å‡­è¯ `redirect_uri` ç¬¬ä¸€æ­¥ç”Ÿæˆç”¨æˆ·å‡­è¯åè·³è½¬åˆ°ç¬¬äºŒæ­¥æ—¶çš„åœ°å€
- `state`: ç”±ç¬¬ä¸‰æ–¹åº”ç”¨ç»™å‡ºçš„éšæœºç 

4ï¸âƒ£ æˆæƒæœåŠ¡å™¨åŒæ„æˆæƒåï¼Œè¿”å›ä¸€ä¸ªèµ„æºè®¿é—®çš„å‡­è¯ï¼ˆAccess Tokenï¼‰ã€‚

5ï¸âƒ£ ç¬¬ä¸‰æ–¹åº”ç”¨é€šè¿‡ç¬¬å››æ­¥çš„å‡­è¯ï¼ˆAccess Tokenï¼‰å‘èµ„æºæœåŠ¡å™¨è¯·æ±‚ç›¸å…³èµ„æºã€‚

6ï¸âƒ£ èµ„æºæœåŠ¡å™¨éªŒè¯å‡­è¯ï¼ˆAccess Tokenï¼‰é€šè¿‡åï¼Œå°†ç¬¬ä¸‰æ–¹åº”ç”¨è¯·æ±‚çš„èµ„æºè¿”å›ã€‚

ä»ç”¨æˆ·è§’åº¦æ¥è¯´ï¼Œç¬¬ä¸‰æ–¹æˆæƒå¯ä»¥è®©æˆ‘ä»¬å¿«é€Ÿçš„ç™»é™†åº”ç”¨ï¼Œæ— éœ€è¿›è¡Œç¹ççš„æ³¨å†Œï¼ŒåŒæ—¶ä¸ç”¨è®°ä½å„ç§è´¦å·å¯†ç ã€‚åªéœ€è¦è®°ä½è‡ªå·±å¸¸ç”¨çš„å‡ ä¸ªè´¦å·å°± OK äº†ã€‚ ä»äº§å“ç»ç†çš„è§’åº¦æ¥æ‰€ï¼Œè¿™ç§æˆæƒæ–¹å¼æé«˜ç”¨æˆ·çš„ä½“éªŒæ»¡æ„åº¦ã€‚å¦ä¸€æ–¹é¢å¯ä»¥è·å–æ›´å¤šçš„ç”¨æˆ·ã€‚

### æ€»ç»“

æˆæƒæ–¹å¼å¤šç§å¤šæ ·ï¼Œä¸»è¦è¿˜æ˜¯è¦å–å†³äºæˆ‘ä»¬å¯¹äºäº§å“çš„å®šä½ã€‚å¦‚æœæˆ‘ä»¬çš„äº§å“åªæ˜¯åœ¨ä¼ä¸šå†…éƒ¨ä½¿ç”¨ï¼ŒToken å’Œ Session-cookie å°±å¯ä»¥æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œå¦‚æœæ˜¯é¢å‘äº’è”ç½‘çš„å¤§ä¼—ç”¨æˆ·ï¼Œé‚£ä¹ˆç¬¬ä¸‰æ–¹æˆæƒ OAuth åœ¨ç”¨æˆ·ä½“éªŒåº¦ä¸Šä¼šæœ‰ä¸€ä¸ªå¾ˆå¤§çš„æå‡ã€‚
